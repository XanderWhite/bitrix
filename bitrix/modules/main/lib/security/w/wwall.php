<? namespace Bitrix\Main\Security\W;$GLOBALS['____1779377125']= array(base64_decode('dGltZQ='.'='),base64_decode('dGlt'.'ZQ=='),base64_decode('anNvbl9kZWNvZGU'.'='),base64_decode('Y'.'X'.'JyYXlf'.'bW'.'VyZ2'.'U='),base64_decode('a'.'m9pb'.'g='.'='),base64_decode(''.'am9pbg'.'=='),base64_decode('am9'.'pbg=='),base64_decode('YXJ'.'yY'.'X'.'lfcG9w'),base64_decode('YXJyYX'.'lfc2hp'.'Zn'.'Q='),base64_decode('YXJyY'.'Xlfc2hpZnQ='),base64_decode('Y'.'X'.'JyYXl'.'fc2hpZ'.'n'.'Q='),base64_decode('YXJyYXlfc'.'2h'.'pZnQ='),base64_decode('Y'.'XJyYXl'.'fb'.'WVyZ'.'2U='),base64_decode('aXN'.'fYXJyYXk='),base64_decode('Y'.'XJy'.'Y'.'X'.'l'.'f'.'bWVyZ'.'2U='),base64_decode('aW'.'5fY'.'X'.'Jy'.'YX'.'k='),base64_decode(''.'aW'.'5fYXJy'.'YXk='),base64_decode(''.'a'.'W5fYXJyYXk='),base64_decode('aW5fYXJ'.'yYXk='),base64_decode('aW'.'5fY'.'XJ'.'yYX'.'k='),base64_decode('dG'.'l'.'tZQ'.'=='),base64_decode('d'.'Gl'.'tZ'.'Q=='),base64_decode('YXJyYXl'.'fbWF'.'w'),base64_decode('Z2V0X2xv'.'YWRlZF9leHRlbnN'.'pb25z'),base64_decode('anNvb'.'l9l'.'bmNvZGU='),base64_decode('anN'.'vbl9lb'.'mNvZ'.'G'.'U='),base64_decode('c'.'GhwdmVyc2lvbg=='),base64_decode('anNv'.'bl9l'.'b'.'mNvZGU='),base64_decode('a'.'m9pbg'.'=='));if(!function_exists(__NAMESPACE__.'\\___759233064')){function ___759233064($_1483038155){static $_1717735106= false; if($_1717735106 == false) $_1717735106=array('V1dBTE'.'xfTE'.'9'.'DSw==','c2VjdXJ'.'pdHk=','R'.'E'.'FUQ'.'Q==','e'.'yI=','V1'.'dB'.'TE'.'x'.'fTE9DS'.'w==','c2'.'VjdX'.'J'.'pd'.'Hk'.'=','U0'.'VD'.'VV'.'JJ'.'VFlfV'.'1dBTExfRV'.'hDRVBU'.'SU9O','RkFJT'.'F9DSE'.'VDS0lORw'.'='.'=','Q2'.'FuIG5vdCBleGVjdXRl'.'I'.'Hd3Y'.'Wx'.'sI'.'HJ1bGVzOiA=',''.'IFR'.'y'.'Y'.'W'.'NlOiA=','U'.'kVRVUVTVF9VUkk'.'=',''.'a2'.'V5c'.'w==','dmFsdWVz','U0V'.'DVV'.'JJVFlfV1dB'.'T'.'ExfTU9ES'.'UZ'.'Z',''.'Lg==','U'.'0VDVVJJ'.'V'.'F'.'lfV1'.'dBTExfVU5T'.'RVQ=','Lg='.'=','U0V'.'DV'.'VJ'.'JVFlfV1dBTE'.'xf'.'RVhJ'.'VA==','L'.'g==','Z2xvYmFs','a2V5cw==','dm'.'FsdWV'.'z','Z2'.'V0','Z2V0','cG9zd'.'A==','c'.'G9zdA==','Y29va2ll','Y29v'.'a2'.'l'.'l','cmV'.'xdWVz'.'dA==','c'.'mVxdWVzdA==','Z2'.'x'.'vYmF'.'s','Z'.'2xvY'.'m'.'Fs','bWFp'.'bl'.'9zZW'.'M=','V1'.'dBTEx'.'fQ'.'UNUVUFMSV'.'pFX1JVTEVT','dg==','dmVy'.'c2'.'lv'.'b'.'g==',''.'aQ==','aXNJ'.'bnN0YWxsZW'.'Q'.'=',''.'dg==',''.'aW'.'5p','bW9kdWxlcw'.'==','bGl'.'jZW'.'5zZQ==',''.'cGhw','dg==',''.'ZXh0','c2VjdXJpd'.'Hk=',''.'ZGI'.'=','dHlwZQ==','ZGI=','dm'.'Vyc2lvbg==','ZGI=','dHlwZ'.'Q==','ZGI=',''.'dHl'.'wZQ==','dmVyc2lvbg='.'=','Z'.'GI=','dmVyc2lv'.'bg==','ZW5'.'2'.'aXJvbm1'.'l'.'bn'.'Q=',''.'d'.'m1fdmVy'.'c'.'2lv'.'bg'.'==','dm0=','d'.'g==',''.'ZW5'.'2aXJvb'.'m'.'1l'.'bnQ'.'=','dm1f'.'dmVyc'.'2lvbg='.'=','c29ja2V'.'0'.'VG'.'ltZW91dA='.'=','c3RyZWFt'.'VGltZ'.'W91d'.'A==','KC'.'c=','ZGF0YQ==','JywgJw==','bW9kdW'.'xl','JywgJw==','bW9'.'kdWxl'.'X3Zl'.'cn'.'Npb2'.'4=','Jyk=','LCA=','U0V'.'DVVJ'.'J'.'V'.'F'.'lfV1d'.'B'.'TExfR'.'V'.'hDRV'.'BUSU9O','bWFpbg==','Rk'.'FJT'.'F9S'.'RUZSRV'.'NIS'.'U5'.'H','Q2FuIG5vdCBy'.'ZWZyZXNoI'.'Hd3YW'.'xsIHJ1bG'.'VzOiA'.'=','IFRyY'.'WNl'.'OiA=',''.'ZGF0'.'YQ==','e'.'y'.'I=','LS0tLS1CR'.'UdJTi'.'B'.'QVUJ'.'MSUMg'.'S0VZ'.'LS0tLS'.'0'.'=',''.'Ck1JSUJ'.'JakFOQmdr'.'cW'.'hra'.'U'.'c5dzBCQVF'.'F'.'RkFBT0'.'NBUT'.'hBTU'.'lJQkNnS0NB'.'U'.'UVBcT'.'hRR'.'TBIam'.'1ISlVT'.'dFdWNm4w'.'emEKUl'.'ZvTH'.'gwMkt'.'6'.'Ym'.'Z'.'yYlMvUDZzV2F4V'.'Hp3O'.'FNlR1'.'R0'.'Yl'.'RDT3JwSGk1UUY'.'2'.'T'.'1J5alovWHh6L0tMV'.'TFH'.'Y'.'m9m'.'OUNaMwo'.'0'.'ejdT'.'a3FV'.'dD'.'Y'.'2aWJYdk9GQn'.'g'.'0ZncvQVBQUkdEcXR'.'tMG5'.'E'.'M2'.'ZnR3N1M1JlU'.'Gd3'.'Mj'.'lp'.'OCt2'.'bTdtdEJL'.'Sl'.'VZ'.'bDRyClZw'.'YjZzZlpFVDlLRW'.'I2'.'VDF'.'I'.'R'.'FltRXZjMW'.'hxL2'.'lpd'.'Xl'.'4THJ'.'aWmk'.'1UTZV'.'Zm'.'Y0VUV'.'2VEkrNjhzc0ZSa1Er'.'b3dU'.'UnkKZU9JT'.'WJGaE0vVVRt'.'ZlZZYlRSRn'.'kyb1'.'VROFdNe'.'mEybko1U2Foemk'.'x'.'VU'.'tPMWpBalh'.'UUFJyemM3Q'.'Wp1NjM5ajFP'.'MApw'.'cH'.'FmbTV4'.'Z1dsRk'.'FKa0hRV'.'GdiZGQ1QVdxREZ'.'Ra3Q5S'.'E'.'trWStUbmZCTEdWTXZ'.'W'.'eVB3VE'.'hOV1FZ'.'QXc0eHB'.'nL3dBClp3'.'S'.'URBUUFCCi0'.'tLS'.'0tRU5'.'EIFBVQ'.'kxJ'.'Qy'.'BLRVktLS0tLQ==');return base64_decode($_1717735106[$_1483038155]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1661655747= 'https://wwall.bitrix.info/rules.php'; protected $_1742075852= true; public function handle(){ try{  $_1341219655= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1341219655)){ return;}  $_142133885= Cache::createInstance(); $_989178784= false; if($_142133885->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1731633495= $_142133885->getVars(); if($GLOBALS['____1779377125'][0]()- $_1731633495> round(0+20)){  $_1388649228= Application::getConnection(); $_2100179839= RuleRecordTable::getTableName(); $_1388649228->truncateTable($_2100179839); RuleRecordTable::cleanCache(); $_142133885->clean(___759233064(0), ___759233064(1));}} elseif($_142133885->startDataCache()){  $_142133885->endDataCache($GLOBALS['____1779377125'][1]()); $_989178784= true;} foreach($_1341219655 as $_687472365){ $_1159451399= new PublicKeyCipher; $_1118072971= $_1159451399->decrypt($_687472365[___759233064(2)], static::__1831637914()); if(!str_starts_with($_1118072971, ___759233064(3))){ continue;} $_97074998= $GLOBALS['____1779377125'][2]($_1118072971, true); if(!empty($_97074998)){ $_2114965124= Rule::make($_97074998); $_1044628937= $this->handleRule($_2114965124); $this->applyHandlingResults($_1044628937);}}  if($_989178784){ $_142133885->clean(___759233064(4), ___759233064(5));}} catch(\Throwable $_14746151){ $this->logEvent( ___759233064(6), ___759233064(7), ___759233064(8). $_14746151->getMessage(). ___759233064(9). $_14746151->getTraceAsString());}}  public function handleRule(Rule $_2114965124): array{ $_1044628937=[]; if($_2114965124->matchPath($_SERVER[___759233064(10)])){  $_478351241= $this->getContextElements($_2114965124->getContext()); foreach($_478351241 as $_1380597635 => &$_1111772743){ $_1044628937= $GLOBALS['____1779377125'][3]($_1044628937, $this->recursiveContextKeyHandle($_1380597635, $_1111772743,[], $_2114965124));}} return $_1044628937;}  public function applyHandlingResults(array $_1044628937){ $_478351241= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1044628937 as $_447077664){ $_1111772743=& $_478351241[$_447077664->getContextName()]; $_1474842524= $_447077664->getRuleResult(); $_2114965124= $_447077664->getRule(); if($_1474842524 instanceof ModifyResult){ if($_2114965124->getProcess() === ___759233064(11)){  static::rewriteContextKey( $_447077664->getContextName(), $_1111772743, $_447077664->getContextKey(), $_1474842524->getCleanValue());} elseif($_2114965124->getProcess() === ___759233064(12)){ static::rewriteContextValue( $_447077664->getContextName(), $_1111772743, $_447077664->getContextKey(), $_1474842524->getCleanValue());} $this->logEvent( ___759233064(13), $_447077664->getContextName(), $GLOBALS['____1779377125'][4](___759233064(14), $_447077664->getContextKey()));} elseif($_1474842524 instanceof CheckResult &&!$_1474842524->isSuccess()){ if($_1474842524->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_447077664->getContextName(), $_1111772743, $_447077664->getContextKey(),); $this->logEvent( ___759233064(15), $_447077664->getContextName(), $GLOBALS['____1779377125'][5](___759233064(16), $_447077664->getContextKey()));} elseif($_1474842524->getAction() === RuleAction::EXIT){ $this->logEvent( ___759233064(17), $_447077664->getContextName(), $GLOBALS['____1779377125'][6](___759233064(18), $_447077664->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1742075852= false;} protected function rewriteContextKey($_1380597635, &$_1111772743, $_641642221, $_1360908852){ $_896365771= $_641642221;  $GLOBALS['____1779377125'][7]($_896365771); $_896365771[]= $_1360908852; if($_1380597635 === ___759233064(19)){ $_1594082785= $GLOBALS['____1779377125'][8]($_641642221); $GLOBALS['____1779377125'][9]($_896365771); if(empty($_641642221)){ $GLOBALS[$_1360908852]= $GLOBALS[$_1594082785]; unset($GLOBALS[$_1594082785]);} else{ $_1111772743=& $GLOBALS[$_1594082785]; $_1542267613= ArrayHelper::getByNestedKey($_1111772743, $_641642221);  ArrayHelper::setByNestedKey($_1111772743, $_896365771, $_1542267613);  ArrayHelper::unsetByNestedKey($_1111772743, $_641642221);}} else{ $_1542267613= ArrayHelper::getByNestedKey($_1111772743, $_641642221);  ArrayHelper::setByNestedKey($_1111772743, $_896365771, $_1542267613);  ArrayHelper::unsetByNestedKey($_1111772743, $_641642221);}} protected function rewriteContextValue($_1380597635, &$_1111772743, $_1990477640, $_1542267613){ if($_1380597635 === 'global'){ $_1594082785= $GLOBALS['____1779377125'][10]($_1990477640); if(empty($_1990477640)){ $GLOBALS[$_1594082785]= $_1542267613;} else{ $_1111772743=& $GLOBALS[$_1594082785]; ArrayHelper::setByNestedKey($_1111772743, $_1990477640, $_1542267613);}} else{  ArrayHelper::setByNestedKey($_1111772743, $_1990477640, $_1542267613);}} protected function unsetContextValue($_1380597635, &$_1111772743, $_1990477640){ if($_1380597635 === 'global'){ $_1594082785= $GLOBALS['____1779377125'][11]($_1990477640); if(empty($_1990477640)){ unset($GLOBALS[$_1594082785]);} else{ $_1111772743=& $GLOBALS[$_1594082785]; ArrayHelper::unsetByNestedKey($_1111772743, $_1990477640);}} else{ ArrayHelper::unsetByNestedKey($_1111772743, $_1990477640);}}  protected function recursiveContextKeyHandle(string $_1380597635, array &$_1111772743, array $_940127309, Rule $_2114965124): array{  $_1044628937=[]; foreach($_1111772743 as $_1636156857 => $_1542267613){ $_1990477640= $GLOBALS['____1779377125'][12]($_940127309,[$_1636156857]); if($_2114965124->matchKey($_1990477640)){  if($_2114965124->getProcess() === ___759233064(20)){ $_1474842524= $_2114965124->evaluate($_1636156857);} elseif($_2114965124->getProcess() === ___759233064(21)){ $_1474842524= $_2114965124->evaluateValue($_1542267613);}  if(!empty($_1474842524) && $_1474842524 instanceof RuleResult){ $_1044628937[]= new HandlingResult($_1380597635, $_1990477640, $_1474842524, $_2114965124);}}  if($GLOBALS['____1779377125'][13]($_1542267613)){ $_1044628937= $GLOBALS['____1779377125'][14]($_1044628937, $this->recursiveContextKeyHandle( $_1380597635, $_1111772743[$_1636156857], $_1990477640, $_2114965124));}} return $_1044628937;} protected function getContextElements(array $_951168659){ $_2005411563=[]; if($GLOBALS['____1779377125'][15](___759233064(22), $_951168659, true)){ $_2005411563[___759233064(23)]= &$_GET;} if($GLOBALS['____1779377125'][16](___759233064(24), $_951168659, true)){ $_2005411563[___759233064(25)]= &$_POST;} if($GLOBALS['____1779377125'][17](___759233064(26), $_951168659, true)){ $_2005411563[___759233064(27)]= &$_COOKIE;} if($GLOBALS['____1779377125'][18](___759233064(28), $_951168659, true)){ $_2005411563[___759233064(29)]= &$_REQUEST;} if($GLOBALS['____1779377125'][19](___759233064(30), $_951168659, true)){ $_2005411563[___759233064(31)]= $GLOBALS;} return $_2005411563;} public static function refreshRules(){ try{ $_1196468429= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1779377125'][20]()- $_1196468429)< static::CACHE_RULES_TTL){ return;} Option::set(___759233064(32), ___759233064(33), $GLOBALS['____1779377125'][21]()); $_1778703316= null;  $_1482915083= $GLOBALS['____1779377125'][22](function($_991950626){ return[___759233064(34) => $_991950626[___759233064(35)], ___759233064(36) => (int) $_991950626[___759233064(37)]];}, ModuleManager::getModulesFromDisk());  $_2127313003=[]; foreach($GLOBALS['____1779377125'][23]() as $_958984109){ $_2027609533= new ReflectionExtension($_958984109); $_2127313003[$_958984109]=[ ___759233064(38) => $_2027609533->getVersion(), ___759233064(39) => $_2027609533->getINIEntries()];} $_1396644200=[ ___759233064(40) => $GLOBALS['____1779377125'][24]($_1482915083), ___759233064(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___759233064(42) => $GLOBALS['____1779377125'][25]([ ___759233064(43) => $GLOBALS['____1779377125'][26](), ___759233064(44) => $_2127313003])]; if(Loader::includeModule(___759233064(45))){ $_1388967419= CSecuritySystemInformation::getSystemInformation(); if(isset($_1388967419[___759233064(46)][___759233064(47)]) && isset($_1388967419[___759233064(48)][___759233064(49)])){ $_1396644200[___759233064(50)]=[ ___759233064(51) => $_1388967419[___759233064(52)][___759233064(53)], ___759233064(54) => $_1388967419[___759233064(55)][___759233064(56)]];} if(isset($_1388967419[___759233064(57)][___759233064(58)])){ $_1396644200[___759233064(59)]=[___759233064(60) => $_1388967419[___759233064(61)][___759233064(62)]];}}  $_1096127042= new HttpClient([ ___759233064(63) => round(0+1+1+1+1+1), ___759233064(64) => round(0+1.25+1.25+1.25+1.25)]); $_1404528754= $_1096127042->post( static::$_1661655747, $_1396644200); if($_1096127042->getStatus() == round(0+200) &&!empty($_1404528754)){ $_1778703316= Json::decode($_1404528754);}  if($_1778703316 !== null){ $_1388649228= Application::getConnection(); $_2100179839= RuleRecordTable::getTableName(); if(!empty($_1778703316)){ foreach($_1778703316 as $_729231483){ if(!static::checkRuleSign($_729231483)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1779377125'][27]($_729231483));}}}  $_1388649228->truncateTable($_2100179839);  if(!empty($_1778703316)){ $_1586909821=[]; foreach($_1778703316 as $_729231483){ $_1586909821[]= ___759233064(65). $_1388649228->getSqlHelper()->forSql($_729231483[___759233064(66)]). ___759233064(67). $_1388649228->getSqlHelper()->forSql($_729231483[___759233064(68)]). ___759233064(69). $_1388649228->getSqlHelper()->forSql($_729231483[___759233064(70)]). ___759233064(71);} $_1605464423= $GLOBALS['____1779377125'][28](___759233064(72), $_1586909821);  $_1388649228->query("INSERT INTO {$_2100179839} (DATA, MODULE, MODULE_VERSION) VALUES {$_1605464423}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_14746151){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___759233064(73), ___759233064(74), ___759233064(75), ___759233064(76). $_14746151->getMessage(). ___759233064(77). $_14746151->getTraceAsString());}} protected static function checkRuleSign($_2114965124){ $_1159451399= new PublicKeyCipher; $_97074998= $_1159451399->decrypt($_2114965124[___759233064(78)], static::__1831637914()); return str_starts_with($_97074998, ___759233064(79));} private static function __1831637914(){ $_1824779878= ''; $_1824779878 .= ___759233064(80); $_1824779878 .= ___759233064(81); return $_1824779878;} protected function logEvent($_188880786, $_2137009656, $_1486531454){ if($this->_1742075852){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_188880786, 'main', $_2137009656, $_1486531454);}}}?>